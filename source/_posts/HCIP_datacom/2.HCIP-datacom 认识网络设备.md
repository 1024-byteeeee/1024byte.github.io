---
title: 1、认识网络设备
date: 2022-11-02 02:23:18
tags: HCIP-datacom
categories: HCIP-datacom
typora-root-url: ..
---
# Ⅰ- 网络设备框架
## 1.框式设备硬件模块

为了方便理解网络设备内部的各个功能模块以S12700E-8为例来讲解典型网络设备框架：

如下图所示：
1 - 主控板（MPU，Main Processing Unit）：
负责整个系统的控制平面和管理平面。

2 - 交换网板（SFU，Switch Fabric Unit）：
负责整个系统的数据平面。数据面提供高速无阻塞数据通道，实现各个业务模块之间的业务交换功能。交换网板，接口板上都有自己的管理芯片，与主控板共同组成整个设备的管理控制平面。

3 - 接口板（LPU，Line Processing Unit）：
线路处理单元是物理设备上用提供数据转发功能的模块，提供不同速率的光口、电口。

![S12700E-8](/images/HCIP-datacom-1%E3%80%81%E8%AE%A4%E8%AF%86%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87/S12700E-8.PNG)

#### 1.1.主控板

提供了整个系统的控制平面和管理平面：

1 - 控制平面完成系统的协议处理、业务处理、路由计算、转发控制、业务调度、流量统计、系统安全等功能。

2 - 管理平面完成系统的运行状态监控、环境监控、日志和告警信息处理、系统加载、系统升级等功能。

#### 1.2.交换网板

交换网板提供整个系统的数据平面。

接口板、主控板之间通过交换网板完成通信。

#### 1.3.接口板

接口板提供了不同类型（光口、电口），不同速率的接入接口，通过分布式数据平面对数据进行转发

<br>

## 2.盒式设备硬件模块

不同于框式设备，盒式设备的各个业务模块并不是独立的硬件模块，而是集成在一个框内。

![盒式设备](/images/HCIP-datacom-1%E3%80%81%E8%AE%A4%E8%AF%86%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87/%E7%9B%92%E5%BC%8F%E8%AE%BE%E5%A4%87.PNG)

<br>

## 3.模块连接逻辑图

1 - 框式设备各个模块分为不同的单板，单板之间通过框式设备内部的连接进行通信。

2 - 盒式设备内部集成了这些模块，各个模块之间同样也是通过内部连接进行通信。

3 - 接口板和接口板之间通过交换网板连接了起来，接口板之间的通信统一经由交换网板进行转发。

![模块连接逻辑图](/images/HCIP-datacom-1%E3%80%81%E8%AE%A4%E8%AF%86%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87/%E6%A8%A1%E5%9D%97%E8%BF%9E%E6%8E%A5%E9%80%BB%E8%BE%91%E5%9B%BE.PNG)

<br>

## 4.网络设备逻辑构架

网络设备从逻辑上可以分为以下三个平面：

数据平面、控制管理平面和监控平面。



![网络设备逻辑构架](/images/HCIP-datacom-1%E3%80%81%E8%AE%A4%E8%AF%86%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87/%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87%E9%80%BB%E8%BE%91%E6%9E%84%E6%9E%B6.PNG)

<br>

## 5.控制平面

1 - 设备的控制平面由主控板以及接口板的管理单元组成。

2 - 控制管理平面完成系统的控制管理功能，是整个系统的中枢神经系统。

3 - 控制平面完成系统的协议处理、业务处理、路由运算、转发控制、业务调度、流量统计、系统安全等功能。

4 - 交换机的控制平面用于控制和管理所有网络协议的运行。

5 - 控制平面提供了数据平面数据处理转发前所必须的各种网络信息和转发查询表项。

![控制平面](/images/HCIP-datacom-1%E3%80%81%E8%AE%A4%E8%AF%86%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87/%E6%8E%A7%E5%88%B6%E5%B9%B3%E9%9D%A2.PNG)

<br>

## 6.转发平面

1 - 设备的转发平面由交换网板及接口组成

2 - LPU上存在PEE（转发引擎），其本质也是一个交换芯片，完成本接口板端口之间的交换。

3 - 数据平面完成数据报文的高速处理和内部无阻塞交换。包括报文的封装与解封装、IPv4/IPv6/MPLS转发处理、QoS与调度处理、内部高速交换以及各种统计。

![转发平面](/images/HCIP-datacom-1%E3%80%81%E8%AE%A4%E8%AF%86%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87/%E8%BD%AC%E5%8F%91%E5%B9%B3%E9%9D%A2.PNG)

## 7.监控平面

1 - 监控平面由主控板、接口板的监控单元构成，部分框式设备还会存在单独的集中监控板（CMU）。

2 - 监控平面独立完成系统的环境监控，包括电压检测、系统上下电控制、温度监测与风扇控制等、以保证系统的安全稳定运行，在出现单元故障的情况下及时隔离故障，保障系统其他部分的正常运行。

![监控平面](/images/HCIP-datacom-1%E3%80%81%E8%AE%A4%E8%AF%86%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87/%E7%9B%91%E6%8E%A7%E5%B9%B3%E9%9D%A2.PNG)
<br>

# Ⅱ - 网络设备对报文的处理流程

## 1.报文转发上行、下行

以交换网板为中心，可将报文在设备的行程一分为二，前半程为“上行”，下半程为“下行”。

![转发报文上行、下行](/images/HCIP-datacom-1%E3%80%81%E8%AE%A4%E8%AF%86%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87/%E8%BD%AC%E5%8F%91%E6%8A%A5%E6%96%87%E4%B8%8A%E8%A1%8C%E3%80%81%E4%B8%8B%E8%A1%8C.PNG)

1 - 设备处理报文分类：一种是业务报文，一种是协议报文。

2 - 对于业务报文设备只会进行转发，从一个接口进入之后依据转发表项从另外一个接口发送出去。

3 - 协议报文（如ARP、OSPF、BGP等协议的报文）设备在收到之后会交由控制层面进行处理，如ARP报文交由控制层面处理、判断之后决定是否回应，是否学习ARP报文中的源MAC、源IP。

<br>

## 2.业务报文转发处理流程

业务报文从接口进入上行接口板处理之后，通过框式交换机内部总线交由交换网板，交换网板交由下行接口板处理之后从接口发出去。

![业务报文转发处理流程](/images/HCIP-datacom-1%E3%80%81%E8%AE%A4%E8%AF%86%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87/%E4%B8%9A%E5%8A%A1%E6%8A%A5%E6%96%87%E8%BD%AC%E5%8F%91%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B.PNG)

1 - PFE（Packet Forwarding Engine）：包转发引擎。

2 - 业务报文：服务、应用在交互过程中涉及的报文。

3 - 切片：把报文送往交换网板之前，进行切片处理，也就是把报文按一定粒度进行切片，切成固定长度

4 - 重组：将交换网板发送过来的已经切片的报文进行重新组合

<br>

## 3.确定报文出口（1）

1 - 当报文从接口板进入时，设备需要依据转发表项（IP路由表、MAC地址表等）确定报文的出接口（对于框式设备需要确定下行接口板）。

2 - 报文到达交换网板时已经明确了出接口、下行接口板，因此表项查询需要在上行接口板的处理过程中完成。

3 - 二层转发查询MAC地址表，三层转发查询三层路由表。

![确定报文出口（1）](/images/HCIP-datacom-1%E3%80%81%E8%AE%A4%E8%AF%86%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87/%E7%A1%AE%E5%AE%9A%E6%8A%A5%E6%96%87%E5%87%BA%E5%8F%A3%EF%BC%881%EF%BC%89.PNG)

<br>

## 4.确定报文出口（2）

1 - 转发表项存放在主控板上，报文进入接口板之后，接口板从主控板处查询表项。

2 - 每次转发都需要与主控板进行通信，转发效率低，报文时延增加，对高速率接口板而言转发速率严重下跌。

3 - 二层转发查询MAC地址表，三层转发查询三层路由表

<br>

## 5.确定报文出口（3）

1 - 转发表项存放在接口板上，报文进入接口板之后直接在接口板完成报文查询，报文转发效率高。

2 - 所有接口板上都要存储转发表项，控制平面资源占用率高。

3 - 二层转发查询MAC地址表，三层转发查询三层路由表。

![确定报文出口（3）](/images/HCIP-datacom-1%E3%80%81%E8%AE%A4%E8%AF%86%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87/%E7%A1%AE%E5%AE%9A%E6%8A%A5%E6%96%87%E5%87%BA%E5%8F%A3%EF%BC%883%EF%BC%89.PNG)

<br>

## 6.转发信息

1 - 高端设备业务报文不经过主控板CPU处理，由接口板提供转发信息查询。

2 - 接口板上存在的转发信息并非存在于主控板上的转发表项（IP路由表、MAC地址表...）。主控板生成转发表项之后，生成对应的转发信息下发在接口板。 

![转发信息](/images/HCIP-datacom-1%E3%80%81%E8%AE%A4%E8%AF%86%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87/%E8%BD%AC%E5%8F%91%E4%BF%A1%E6%81%AF.PNG)

以IP路由表为例，路由表生成之后，主控板根据路由表生成FIP表项（Forwarding Information Base）并下发到接口板，接口板根据FIB表进行转发。

<br>

## 7.硬件转发

1 - 接口板执行转发的不见为包转发引擎PFE（Packet Forwarding Engine），通常为NP或者ASIC芯片，报文直接由接口板独立完成转发，无需主控板参与。

2 - 高端框式设备把转发层面和控制层面分配在不同的组件，控制层面组件（主控板）负责运行转发相关协议、维护转发表项，转发平面组件（接口板）依据控制层面下发的转发信息能供独立完成转发工作，互不影响，控制层面组件高负载时并不会影响转发平面的正常工作，这种工作机制被成为转控分离。

![转发信息](/images/HCIP-datacom-1%E3%80%81%E8%AE%A4%E8%AF%86%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87/%E8%BD%AC%E5%8F%91%E4%BF%A1%E6%81%AF.PNG)

业务报文转发由接口板、交换网板独立完成，无主控板参与。

<br>

## 8.协议报文转发处理流程

设备收到的协议报文，如路由协议：
OSPF、IS-IS、BGP报文，ARP报文，STP报文，对设备的ICMP请求报文等，需要交由设备的控制平面处理，即上送主控板由主控板的CPU进行处理。

1 - 主控板CPU收到协议报文之后进行相应的处理之后如果需要回应报文，则主控板会构造协议报文进行回应，如收到发往自身的ARP Request、ICMP Echo Request报文，主控板处理之后构造ARP Reply、ICMP Echo Reply进行回应。

2 - 主控板CPU处理能力有限，如果过多的协议报文上送主控板CPU处理，会造成其繁忙，无法及时对协议报文进行响应，为此设备默认限制了各种类型的协议报文上送主控板CPU的速率。

![协议报文转发处理流程](/images/HCIP-datacom-1%E3%80%81%E8%AE%A4%E8%AF%86%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87/%E5%8D%8F%E8%AE%AE%E6%8A%A5%E6%96%87%E8%BD%AC%E5%8F%91%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B.PNG)

<br>

## 9.设备自身发送协议报文处理流程

设备自身发送的协议报文，如路由协议报文：
OSPF、IS-IS、BGP报文，ARP报文，STP报文，ICMP报文等，由主控板CPU构造之后交由接口板对外发送

![设备自身发送协议报文处理流程](/images/HCIP-datacom-1%E3%80%81%E8%AE%A4%E8%AF%86%E7%BD%91%E7%BB%9C%E8%AE%BE%E5%A4%87/%E8%AE%BE%E5%A4%87%E8%87%AA%E8%BA%AB%E5%8F%91%E9%80%81%E5%8D%8F%E8%AE%AE%E6%8A%A5%E6%96%87%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B.PNG)